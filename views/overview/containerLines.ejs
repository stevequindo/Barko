<%- include("../partials/transactions-header", {user: user}) -%>

<table class="mdl-data-table mdl-js-data-table row-border compact" id="comm-table" style="width:100%">
	<thead>
	<tr>
		<th>BATCH NO.</th>
		<th class="mdl-data-table__cell--non-numeric">TRACKING NO.</th>
		<th class="">COUNT</th>
		<th class="mdl-data-table__cell--non-numeric">AREA</th>
		<th class="mdl-data-table__cell--non-numeric">SENDER</th>
		<th class="mdl-data-table__cell--non-numeric">RECEIVER</th>
		<th class="mdl-data-table__cell--non-numeric">DELIVERY ADDRESS</th>
		<th class="mdl-data-table__cell--non-numeric">STATUS</th>
		<th class="mdl-data-table__cell--non-numeric">ETA TO PORT</th>
		<th class="mdl-data-table__cell--non-numeric">COMMENTS</th>
	</tr>
	</thead>
	<tbody>
	</tbody>
</table>
</div>

<script>
$(document).ready(function() {
	// Initialise editor
	let editor = new $.fn.dataTable.Editor({
		table: '#comm-table',
		idSrc: "_id",
        // serverSide: true,
		fields: [
			{
				label: "Status:",
				name: "status.stage",
				type: "select",
				options: [
					"At Departing Port",
					"On Transit",
					"At Destination Port",
					"At Customs",
					"For Dispatch",
					"For Delivery",
					"Delivered"]
			},
			{
				label:"Estimated Arrival Date to Port",
				type: "datetime",
				name: "status.estPortArrivalDate",
				def: function () { return new Date(); },
				format: 'DD-MM-YYYY'
			},
			{
				label: "Additional Comments: ",
				name: "comment",
			},
        ],
        ajax: {
            edit: {
            	type: 'POST',
                url: '/overview/update',
				headers :{
            		"containerId" : "<%-id%>"
				},
				contentType: 'application/json',
                data: (d) => {
					return JSON.stringify(d.data);
                },
            }
        }
	});

	// Initialise data table
	let table = $('#comm-table').DataTable({
		dom: 'lBfrtip',
		buttons: [
            'selectAll',
			<% if (user != "overseas") { %>
			{ extend: "edit",   editor: editor },
			<% } %>
            'pdf',
	    ],
        lengthMenu: [[25, 50,100, -1], [25, 50,100, "All"]],
		paginate: true,
		processing: true,
		select: true,
		stateSave: true,
		"data":<%- contentArray %>,
		deferRender: true,
		scrollY: 400,
		"scrollX": true,
		scrollCollapse: true,
		scroller:       true,
		"deferLoading": <%- contentArray.length %>,
        columnDefs: [
			{
				targets: "_all",
				className: 'dt-left',
			}
        ],
		"columns": [
			{"data": "batchNo"},
			{"data": "trackingNo"},
			{"data": "count"},
			{"data": "area"},
			{
				"data": null,
				render: function (data, type, row) {
					let firstName = row.sender.firstName;
					let lastName = row.sender.lastName;
					return firstName !== undefined ? `${firstName} ${lastName}` : "<i>Not provided</i>";
				}
			},
			{
				"data": null,
				render: function (data, type, row) {
					let firstName = row.receiver.firstName;
					let lastName = row.receiver.lastName;
					return firstName !== undefined ? `${firstName} ${lastName}` : "<i>Not provided</i>";
				}
			},
			{
				"data": null,
				render: function (data,type,row) {
					let address = row.receiver.address;
					return address !== undefined ? address.toString() : "<i>Not provided</i>";
				},
				// "width": "1rem"
			},
			{"data": "status.stage"},
			{
				"data": "status.estPortArrivalDate",
				render: function(data, type, row) {
					let estPortArrivalDate = row.status.estPortArrivalDate;

					if (estPortArrivalDate) {
						let date = new Date(estPortArrivalDate);
						return date.toDateString();
					} else {
						return 'Unknown';
					}
				},
			},
			{"data": "comment"}
		],
	});
});
</script>
<%- include("../partials/footer") -%>



